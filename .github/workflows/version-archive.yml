name: Version Archive Action

on:
  workflow_call:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆå¦‚ v1.0.0ï¼‰'
        required: false
        type: string
      build_dir:
        description: 'æ„å»ºäº§ç‰©ç›®å½•ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰'
        required: true
        type: string
        default: 'dist'
      archive_branch:
        description: 'å½’æ¡£åˆ†æ”¯åç§°'
        required: false
        type: string
        default: 'gh-pages'
      archive_dir:
        description: 'å½’æ¡£ç›®å½•åç§°'
        required: false
        type: string
        default: 'versions'
      force_archive:
        description: 'å¼ºåˆ¶å½’æ¡£ï¼ˆè¦†ç›–å·²å­˜åœ¨ç‰ˆæœ¬ï¼‰'
        required: false
        type: boolean
        default: false
      enable_pages:
        description: 'æ˜¯å¦éƒ¨ç½²åˆ° GitHub Pages'
        required: false
        type: boolean
        default: true
    # GITHUB_TOKEN æ˜¯ç³»ç»Ÿè‡ªåŠ¨æä¾›çš„ï¼Œæ— éœ€åœ¨æ­¤å£°æ˜

jobs:
  archive-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout è°ƒç”¨æ–¹ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout ç‰ˆæœ¬å½’æ¡£å·¥å…·
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/version-stage-workflow
        path: .version-archive-tools
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: å®‰è£…ç‰ˆæœ¬å½’æ¡£å·¥å…·ä¾èµ–
      run: |
        cd .version-archive-tools
        npm install --production

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./downloaded-artifacts
      continue-on-error: true

    - name: éªŒè¯æ„å»ºäº§ç‰©ç›®å½•
      run: |
        echo "ğŸ” æ£€æŸ¥ä¸‹è½½çš„æ„å»ºäº§ç‰©ï¼š"
        ls -la ./downloaded-artifacts/
        
        # æ£€æŸ¥åŸå§‹æ„å»ºç›®å½•è·¯å¾„
        BUILD_PATH="./downloaded-artifacts/${{ inputs.build_dir }}"
        
        # å¦‚æœbuild_diræ˜¯"."ï¼Œåˆ™ç›´æ¥ä½¿ç”¨downloaded-artifacts
        if [ "${{ inputs.build_dir }}" = "." ]; then
          BUILD_PATH="./downloaded-artifacts"
        fi
        
        echo "ğŸ¯ ç›®æ ‡æ„å»ºè·¯å¾„: $BUILD_PATH"
        
        if [ -d "$BUILD_PATH" ]; then
          echo "âœ… æ„å»ºäº§ç‰©ç›®å½•å­˜åœ¨: $BUILD_PATH"
          echo "ğŸ“ ç›®å½•å†…å®¹ï¼š"
          ls -la "$BUILD_PATH"
        else
          echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨: $BUILD_PATH"
          echo "ğŸ’¡ æç¤ºï¼šè¯·ç¡®ä¿åœ¨build jobä¸­ä¸Šä¼ äº†æ­£ç¡®çš„artifact"
          echo "ğŸ“‹ ä¸‹è½½çš„artifactç»“æ„ï¼š"
          find ./downloaded-artifacts -type d 2>/dev/null || true
          exit 1
        fi

    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        if [ -n "${{ inputs.version }}" ]; then
          VERSION="${{ inputs.version }}"
        elif [ "${{ github.ref_type }}" == "tag" ]; then
          VERSION="${{ github.ref_name }}"
        else
          # ä» package.json è·å–ç‰ˆæœ¬å·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "package.json" ]; then
            VERSION="v$(node -p "require('./package.json').version" 2>/dev/null || echo "1.0.0")"
          else
            VERSION="v1.0.0"
          fi
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "clean_version=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ ä½¿ç”¨ç‰ˆæœ¬å·: $VERSION"

    - name: æ£€å‡ºå½’æ¡£åˆ†æ”¯
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.archive_branch }}
        path: archive
        token: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: åˆ›å»ºå½’æ¡£åˆ†æ”¯ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      run: |
        if [ ! -d "archive" ]; then
          echo "ğŸ“ åˆ›å»ºæ–°çš„å½’æ¡£åˆ†æ”¯: ${{ inputs.archive_branch }}"
          git checkout --orphan ${{ inputs.archive_branch }}
          git rm -rf . 2>/dev/null || true
          echo "# ç‰ˆæœ¬å½’æ¡£" > README.md
          mkdir -p ${{ inputs.archive_dir }}
          git add .
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Initialize archive branch"
          git push origin ${{ inputs.archive_branch }}
          
          # é‡æ–°æ£€å‡ºå½’æ¡£åˆ†æ”¯
          git checkout main 2>/dev/null || git checkout master 2>/dev/null || true
          git worktree add archive ${{ inputs.archive_branch }}
        else
          echo "âœ… å½’æ¡£åˆ†æ”¯å·²å­˜åœ¨ï¼Œæ£€æŸ¥ç›®å½•ç»“æ„"
          ls -la archive/
        fi
        
        # ç¡®ä¿å½’æ¡£ç›®å½•å­˜åœ¨
        mkdir -p archive/${{ inputs.archive_dir }}
        echo "ğŸ“ å½’æ¡£ç›®å½•ç»“æ„ï¼š"
        ls -la archive/

    - name: å¤åˆ¶ç‰ˆæœ¬åˆ‡æ¢å™¨èµ„æº
      run: |
        # ç¡®ä¿å½’æ¡£ç›®å½•å­˜åœ¨
        mkdir -p archive/${{ inputs.archive_dir }}
        
        # å¤åˆ¶ç‰ˆæœ¬åˆ‡æ¢å™¨æ–‡ä»¶åˆ°å½’æ¡£ç›®å½•
        cp .version-archive-tools/src/version-switcher.js archive/${{ inputs.archive_dir }}/
        cp .version-archive-tools/src/version-switcher.css archive/${{ inputs.archive_dir }}/
        
        echo "âœ… ç‰ˆæœ¬åˆ‡æ¢å™¨èµ„æºå·²å¤åˆ¶åˆ° archive/${{ inputs.archive_dir }}/"

    - name: æ‰§è¡Œç‰ˆæœ¬å½’æ¡£
      run: |
        echo "ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š"
        echo "ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.version }}"
        echo "æ¸…æ´ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.clean_version }}"
        echo "æ„å»ºç›®å½•: ${{ inputs.build_dir }}"
        echo "å½’æ¡£ç›®å½•: archive/${{ inputs.archive_dir }}"
        echo "å¼ºåˆ¶å½’æ¡£: ${{ inputs.force_archive }}"
        
        # ç¡®å®šæ­£ç¡®çš„æ„å»ºç›®å½•è·¯å¾„
        if [ "${{ inputs.build_dir }}" = "." ]; then
          BUILD_PATH="../downloaded-artifacts"
        else
          BUILD_PATH="../downloaded-artifacts/${{ inputs.build_dir }}"
        fi
        
        echo "ğŸ¯ å®é™…æ„å»ºè·¯å¾„: $BUILD_PATH"
        
        cd .version-archive-tools
        node scripts/archive-version.js \
          --version="${{ steps.get_version.outputs.version }}" \
          --clean-version="${{ steps.get_version.outputs.clean_version }}" \
          --build-dir="$BUILD_PATH" \
          --archive-dir="../archive/${{ inputs.archive_dir }}" \
          --force="${{ inputs.force_archive }}"

    - name: æ›´æ–°ç‰ˆæœ¬ç´¢å¼•
      run: |
        cd .version-archive-tools
        node scripts/update-version-index.js \
          --archive-dir="../archive/${{ inputs.archive_dir }}" \
          --version="${{ steps.get_version.outputs.version }}"

    - name: æäº¤å½’æ¡£æ›´æ”¹
      run: |
        cd archive
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        else
          git commit -m "Archive version ${{ steps.get_version.outputs.version }}"
          git push origin ${{ inputs.archive_branch }}
          echo "âœ… ç‰ˆæœ¬ ${{ steps.get_version.outputs.version }} å½’æ¡£å®Œæˆ"
        fi

    - name: éƒ¨ç½²åˆ° GitHub Pages
      if: ${{ inputs.enable_pages }}
      uses: actions/deploy-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: archive
