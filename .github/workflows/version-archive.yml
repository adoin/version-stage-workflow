name: Version Archive Action

on:
  workflow_call:
    inputs:
      build_dir:
        description: 'æ„å»ºäº§ç‰©ç›®å½•ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰'
        required: true
        type: string
        default: 'dist'
      archive_branch:
        description: 'å½’æ¡£åˆ†æ”¯åç§°'
        required: false
        type: string
        default: 'gh-pages'
      archive_dir:
        description: 'å½’æ¡£ç›®å½•åç§°'
        required: false
        type: string
        default: 'versions'
      force_archive:
        description: 'å¼ºåˆ¶å½’æ¡£ï¼ˆè¦†ç›–å·²å­˜åœ¨ç‰ˆæœ¬ï¼‰'
        required: false
        type: boolean
        default: false
      enable_pages:
        description: 'æ˜¯å¦éƒ¨ç½²åˆ° GitHub Pages'
        required: false
        type: boolean
        default: true
      path_prefix:
        description: 'ç»å¯¹è·¯å¾„å‰ç¼€ï¼Œç•™ç©ºè‡ªåŠ¨æ£€æµ‹'
        required: false
        type: string
        default: ''
    # GITHUB_TOKEN æ˜¯ç³»ç»Ÿè‡ªåŠ¨æä¾›çš„ï¼Œæ— éœ€åœ¨æ­¤å£°æ˜

jobs:
  archive-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout è°ƒç”¨æ–¹ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout ç‰ˆæœ¬å½’æ¡£å·¥å…·
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/version-stage-workflow
        path: .version-archive-tools
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: å®‰è£…ç‰ˆæœ¬å½’æ¡£å·¥å…·ä¾èµ–
      run: |
        cd .version-archive-tools
        npm install --production

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      id: download_artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./build-output
      continue-on-error: true

    - name: æ£€æŸ¥ artifact ä¸‹è½½çŠ¶æ€
      run: |
        if [ "${{ steps.download_artifacts.outcome }}" = "failure" ]; then
          echo "âŒ Artifact ä¸‹è½½å¤±è´¥ï¼"
          echo "ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š"
          echo "   1. build job æ²¡æœ‰æˆåŠŸä¸Šä¼  artifact"
          echo "   2. artifact åç§°ä¸åŒ¹é…ï¼ˆæœŸæœ›: build-artifactsï¼‰"
          echo "   3. artifact å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨"
          echo ""
          echo "ğŸ” è¯·æ£€æŸ¥è°ƒç”¨æ–¹å·¥ä½œæµçš„ build jobï¼š"
          echo "   - uses: actions/upload-artifact@v4"
          echo "     with:"
          echo "       name: build-artifacts  # ğŸ‘ˆ å¿…é¡»æ˜¯è¿™ä¸ªåç§°"
          echo "       path: your-build-dir"
          exit 1
        fi
        
        echo "âœ… Artifact ä¸‹è½½æˆåŠŸ"

    - name: éªŒè¯æ„å»ºäº§ç‰©ç›®å½•
      run: |
        echo "ğŸ” æ£€æŸ¥ä¸‹è½½çš„æ„å»ºäº§ç‰©ï¼š"
        ls -la ./build-output/
        
        # ç¡®å®šæ„å»ºäº§ç‰©çš„å®é™…è·¯å¾„
        if [ "${{ inputs.build_dir }}" = "." ]; then
          BUILD_PATH="./build-output"
        else
          BUILD_PATH="./build-output/${{ inputs.build_dir }}"
        fi
        
        echo "ğŸ¯ ç›®æ ‡æ„å»ºè·¯å¾„: $BUILD_PATH"
        
        if [ -d "$BUILD_PATH" ]; then
          echo "âœ… æ„å»ºäº§ç‰©ç›®å½•å­˜åœ¨: $BUILD_PATH"
          echo "ğŸ“ ç›®å½•å†…å®¹ï¼š"
          ls -la "$BUILD_PATH"
        else
          echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨: $BUILD_PATH"
          echo "ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š"
          echo "   1. build_dir å‚æ•°è®¾ç½®é”™è¯¯ï¼ˆå½“å‰: ${{ inputs.build_dir }}ï¼‰"
          echo "   2. è°ƒç”¨æ–¹ä¸Šä¼ çš„ artifact ç›®å½•ç»“æ„ä¸æ­£ç¡®"
          echo ""
          echo "ğŸ“‹ å®é™…çš„ artifact ç»“æ„ï¼š"
          find ./build-output -type d 2>/dev/null || echo "   (ç©ºç›®å½•)"
          echo ""
          echo "ğŸ“‹ artifact ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼š"
          find ./build-output -type f 2>/dev/null || echo "   (æ— æ–‡ä»¶)"
          exit 1
        fi

    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        # åªä» package.json è·å–ç‰ˆæœ¬å·
        if [ -f "package.json" ]; then
          PACKAGE_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "")
          if [ -n "$PACKAGE_VERSION" ]; then
            VERSION="v$PACKAGE_VERSION"
          else
            echo "âŒ æ— æ³•ä» package.json è¯»å–ç‰ˆæœ¬å·"
            echo "ğŸ’¡ è¯·ç¡®ä¿ package.json åŒ…å«æœ‰æ•ˆçš„ version å­—æ®µ"
            exit 1
          fi
        else
          echo "âŒ æœªæ‰¾åˆ° package.json æ–‡ä»¶"
          echo "ğŸ’¡ æ­¤å·¥ä½œæµéœ€è¦é¡¹ç›®åŒ…å« package.json æ–‡ä»¶å¹¶å®šä¹‰ version å­—æ®µ"
          echo "ğŸ“‹ å½“å‰ç›®å½•å†…å®¹ï¼š"
          ls -la
          exit 1
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "clean_version=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ ä» package.json è·å–ç‰ˆæœ¬å·: $VERSION"

    - name: æ£€æŸ¥å½’æ¡£åˆ†æ”¯æ˜¯å¦å­˜åœ¨
      id: check_branch
      run: |
        # æ£€æŸ¥è¿œç¨‹åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if git ls-remote --heads origin ${{ inputs.archive_branch }} | grep -q ${{ inputs.archive_branch }}; then
          echo "branch_exists=true" >> $GITHUB_OUTPUT
          echo "âœ… å½’æ¡£åˆ†æ”¯ ${{ inputs.archive_branch }} å·²å­˜åœ¨"
        else
          echo "branch_exists=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ å½’æ¡£åˆ†æ”¯ ${{ inputs.archive_branch }} ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º"
        fi

    - name: æ£€å‡ºç°æœ‰å½’æ¡£åˆ†æ”¯
      if: steps.check_branch.outputs.branch_exists == 'true'
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.archive_branch }}
        path: archive
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: åˆ›å»ºæ–°çš„å½’æ¡£åˆ†æ”¯
      if: steps.check_branch.outputs.branch_exists == 'false'
      run: |
        echo "ğŸ“ åˆ›å»ºæ–°çš„å½’æ¡£åˆ†æ”¯: ${{ inputs.archive_branch }}"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•æ¥åˆå§‹åŒ–åˆ†æ”¯
        mkdir -p /tmp/init-archive
        cd /tmp/init-archive
        
        # åˆå§‹åŒ–æ–°çš„ git ä»“åº“
        git init
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
        
        # åˆ›å»ºåˆå§‹å†…å®¹
        echo "# ç‰ˆæœ¬å½’æ¡£åˆ†æ”¯" > README.md
        echo "" >> README.md
        echo "æ­¤åˆ†æ”¯ç”¨äºå­˜å‚¨é¡¹ç›®çš„å†å²ç‰ˆæœ¬ã€‚" >> README.md
        echo "" >> README.md
        echo "- å½’æ¡£ç›®å½•: ${{ inputs.archive_dir }}" >> README.md
        echo "- åˆ›å»ºæ—¶é—´: $(date)" >> README.md
        
        mkdir -p ${{ inputs.archive_dir }}
        
        # æäº¤å¹¶æ¨é€åˆ°è¿œç¨‹
        git add .
        git commit -m "Initialize archive branch ${{ inputs.archive_branch }}"
        git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push -u origin HEAD:${{ inputs.archive_branch }}
        
        # å›åˆ°å·¥ä½œç›®å½•
        cd ${{ github.workspace }}
        
        # åˆ›å»ºå·¥ä½œæ ‘
        git worktree add archive ${{ inputs.archive_branch }}

    - name: è®¾ç½®å½’æ¡£åˆ†æ”¯å·¥ä½œæ ‘
      if: steps.check_branch.outputs.branch_exists == 'true'
      run: |
        echo "âœ… å½’æ¡£åˆ†æ”¯å·²å­˜åœ¨ï¼Œè®¾ç½®å·¥ä½œæ ‘"
        git worktree add archive ${{ inputs.archive_branch }} 2>/dev/null || true
        
        # ç¡®ä¿å½’æ¡£ç›®å½•å­˜åœ¨
        mkdir -p archive/${{ inputs.archive_dir }}
        echo "ğŸ“ å½’æ¡£ç›®å½•ç»“æ„ï¼š"
        ls -la archive/

    - name: å¤åˆ¶ç‰ˆæœ¬åˆ‡æ¢å™¨èµ„æº
      run: |
        # ç¡®ä¿å½’æ¡£ç›®å½•å­˜åœ¨
        mkdir -p archive/${{ inputs.archive_dir }}
        
        # å¤åˆ¶ç‰ˆæœ¬åˆ‡æ¢å™¨æ–‡ä»¶åˆ°å½’æ¡£æ ¹ç›®å½•ï¼ˆä¸»é¡µé¢éœ€è¦ï¼‰
        cp .version-archive-tools/src/version-switcher-iframe.js archive/
        
        # ä¹Ÿå¤åˆ¶åˆ°ç‰ˆæœ¬ç›®å½•ï¼ˆå…¼å®¹æ€§ï¼‰
        cp .version-archive-tools/src/version-switcher.js archive/${{ inputs.archive_dir }}/
        cp .version-archive-tools/src/version-switcher.css archive/${{ inputs.archive_dir }}/
        
        echo "âœ… ç‰ˆæœ¬åˆ‡æ¢å™¨èµ„æºå·²å¤åˆ¶åˆ°å½’æ¡£ç›®å½•"

    - name: æ‰§è¡Œç‰ˆæœ¬å½’æ¡£
      run: |
        echo "ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š"
        echo "ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.version }}"
        echo "æ¸…æ´ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.clean_version }}"
        echo "æ„å»ºç›®å½•: ${{ inputs.build_dir }}"
        echo "å½’æ¡£ç›®å½•: archive/${{ inputs.archive_dir }}"
        echo "å¼ºåˆ¶å½’æ¡£: ${{ inputs.force_archive }}"
        
        # ç¡®å®šæ­£ç¡®çš„æ„å»ºç›®å½•è·¯å¾„
        if [ "${{ inputs.build_dir }}" = "." ]; then
          BUILD_PATH="../build-output"
        else
          BUILD_PATH="../build-output/${{ inputs.build_dir }}"
        fi
        
        echo "ğŸ¯ å®é™…æ„å»ºè·¯å¾„: $BUILD_PATH"
        
        cd .version-archive-tools
        # æ„å»ºå½’æ¡£å‘½ä»¤
        ARCHIVE_CMD="node scripts/archive-version.js \
          --version=\"${{ steps.get_version.outputs.version }}\" \
          --clean-version=\"${{ steps.get_version.outputs.clean_version }}\" \
          --build-dir=\"$BUILD_PATH\" \
          --archive-dir=\"../archive/${{ inputs.archive_dir }}\" \
          --force=\"${{ inputs.force_archive }}\""
        
        # å¦‚æœæŒ‡å®šäº†è·¯å¾„å‰ç¼€ï¼Œæ·»åŠ åˆ°å‘½ä»¤ä¸­
        if [ -n "${{ inputs.path_prefix }}" ]; then
          ARCHIVE_CMD="$ARCHIVE_CMD --path-prefix=\"${{ inputs.path_prefix }}\""
          echo "ğŸ¯ ä½¿ç”¨æŒ‡å®šçš„è·¯å¾„å‰ç¼€: ${{ inputs.path_prefix }}"
        else
          echo "ğŸ” å°†è‡ªåŠ¨æ£€æµ‹è·¯å¾„å‰ç¼€"
        fi
        
        # æ‰§è¡Œå½’æ¡£å‘½ä»¤
        eval $ARCHIVE_CMD

    - name: æ›´æ–°ç‰ˆæœ¬ç´¢å¼•
      run: |
        cd .version-archive-tools
        node scripts/update-version-index.js \
          --archive-dir="../archive/${{ inputs.archive_dir }}" \
          --version="${{ steps.get_version.outputs.version }}"

    - name: æäº¤å½’æ¡£æ›´æ”¹
      run: |
        cd archive
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        else
          git commit -m "Archive version ${{ steps.get_version.outputs.version }}"
          git push origin ${{ inputs.archive_branch }}
          echo "âœ… ç‰ˆæœ¬ ${{ steps.get_version.outputs.version }} å½’æ¡£å®Œæˆ"
        fi

    - name: æ£€æŸ¥å½’æ¡£ç›®å½•ç»“æ„
      run: |
        echo "ğŸ” æ£€æŸ¥å½’æ¡£ç›®å½•ç»“æ„ï¼š"
        ls -la archive/
        echo ""
        echo "ğŸ“‹ ç‰ˆæœ¬ç›®å½•å†…å®¹ï¼š"
        ls -la archive/${{ inputs.archive_dir }}/ || echo "ç‰ˆæœ¬ç›®å½•ä¸ºç©º"
        echo ""
        echo "ğŸ“„ ç‰ˆæœ¬ç´¢å¼•æ–‡ä»¶ï¼š"
        if [ -f "archive/${{ inputs.archive_dir }}/index.json" ]; then
          echo "âœ… index.json å­˜åœ¨"
          cat archive/${{ inputs.archive_dir }}/index.json
        else
          echo "âŒ index.json ä¸å­˜åœ¨"
        fi

    - name: åˆ›å»ºç‰ˆæœ¬æµè§ˆä¸»é¡µ
      run: |
        cd archive
        
        # åˆ›å»ºç®€æ´çš„ç‰ˆæœ¬æµè§ˆä¸»é¡µ
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ç‰ˆæœ¬å½’æ¡£</title>
            <style>
                body {
                    margin: 0;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    background: #f5f5f5;
                }
                .main-content {
                    margin: 0;
                    padding: 0;
                    width: 100vw;
                    height: 100vh;
                    position: relative;
                }
                #version-iframe {
                    width: 100%;
                    height: 100%;
                    border: none;
                    display: block;
                }
                .loading {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: #666;
                    font-size: 18px;
                }
            </style>
        </head>
        <body>
            <div class="main-content">
                <div class="loading" id="loading">æ­£åœ¨åŠ è½½æœ€æ–°ç‰ˆæœ¬...</div>
                <iframe id="version-iframe" style="display: none;"></iframe>
            </div>
            
            <!-- ç‰ˆæœ¬åˆ‡æ¢å™¨ -->
            <script src="version-switcher-iframe.js"></script>
        </body>
        </html>
        EOF
        
        echo "âœ… åˆ›å»ºäº†ç‰ˆæœ¬æµè§ˆä¸»é¡µ"

    - name: ä¸Šä¼ å½’æ¡£äº§ç‰©åˆ° Pages
      if: ${{ inputs.enable_pages }}
      uses: actions/upload-pages-artifact@v4
      with:
        path: archive

    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      if: ${{ inputs.enable_pages }}
      uses: actions/deploy-pages@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}